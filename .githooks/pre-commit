#!/bin/bash

set -euo pipefail

# Pre-commit hook for Swift code formatting
# åœ¨æäº¤å‰è‡ªåŠ¨æ ¼å¼åŒ– Swift ä»£ç 

REPO_ROOT="$(git rev-parse --show-toplevel)"
CONFIG_FILE="$REPO_ROOT/.swift-format"

if ! command -v swift-format >/dev/null 2>&1; then
    echo "âš ï¸  æœªæ‰¾åˆ° swift-formatï¼Œè·³è¿‡æ ¼å¼åŒ–"
    echo "   å®‰è£…æ–¹æ³•: brew install swift-format"
    echo ""
    echo "   æˆ–è€…è·³è¿‡æ­¤æ£€æŸ¥: git commit --no-verify"
    exit 0
fi

SWIFT_FILES=()
while IFS= read -r -d '' file; do
    SWIFT_FILES+=("$file")
done < <(git diff --cached --name-only --diff-filter=ACM -z -- '*.swift')

if [ "${#SWIFT_FILES[@]}" -eq 0 ]; then
    exit 0
fi

echo "ğŸ” æ£€æµ‹åˆ° Swift æ–‡ä»¶å˜æ›´ï¼Œå¼€å§‹æ ¼å¼åŒ–..."

FORMATTED_COUNT=0
for file in "${SWIFT_FILES[@]}"; do
    if [ -f "$file" ]; then
        echo "  ğŸ“ æ ¼å¼åŒ–: $file"
        swift-format format --configuration "$CONFIG_FILE" --in-place "$file"
        git add "$file"
        FORMATTED_COUNT=$((FORMATTED_COUNT + 1))
    fi
done

echo "âœ… æ ¼å¼åŒ–å®Œæˆ ($FORMATTED_COUNT ä¸ªæ–‡ä»¶)"
echo ""
